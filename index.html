<!DOCTYPE html>
<html>
<head>
	<title>Covid Counter</title>
	
	<script src="jquery-3.5.1.min.js"></script>
	<style>
		header{
			background: #333;
			color: #fff;
			padding: 20px;
			text-align: center;
			border-bottom: 4px #000 solid;
			//margin-bottom: 10px;
		}
		body{
			background: #f4f4f4;
		}
		#nav{
			background:pink;
			height: 25px;
		}
	</style>
</head>

<body>
	<header>
		<h1>Covid Counter</h1>
		
		<div id="cases"></div>
		<div id="deaths"></div>
	
	</header>
	
	<div id="nav">
		<p id="test">Test2</p>
	</div>
	
	<div id="dataSelector">
		<form>
			<label>Select Region:</label>
			<select id="regionSelect">
				<option value="all">All</option>
			</select>
		</form>
	</div>
	
	<div id="regionData">
		
	</div>

</body>


<script>
	var regions = [];
	var covidData;
	var newCaseUS = 0;
	var newDeathUS = 0;
	var d = new Date();
	
	function secondPer(num){
		return 86400./num;
	}

    function prevDay(dateObject){
	    dateObject.setTime(parseInt(dateObject.getTime())-24*60*60*1000);
	}
	
	function displayRegionData(region, newCases, newDeaths){
	
		$("#regionData").html("<h1>" + region + "</h1><h3>" + d.toJSON().substring(0,10) + "</h3><p>New Cases: " + newCases + " | every " + secondPer(newCases).toFixed(2) +  " seconds<br>New Deaths: " + newDeaths  + " | every " + secondPer(newDeaths).toFixed(2) +  " seconds</p>");
	}
	
	function getCDCData(){
		$.ajax({
			url: "https://data.cdc.gov/resource/9mfq-cb36.json",
			type: "GET",
			data: {
				"$limit" : 5000,
				 "submission_date" : d.toJSON().substring(0,10)
			}
		}).done(function(data) {
			covidData = data;
			
			if(jQuery.isEmptyObject(data)){
				prevDay(d);
				
				getCDCData();
			}
			else{
				$.each(data, function(i, stateData){
					regions.push(stateData.state);
					//$("select#regionSelect").append('<option value="' + stateData.state + '">' + stateData.state + '</option>');
					
					newCaseUS += parseInt(stateData.new_case);
					newDeathUS += parseInt(stateData.new_death);
				});
				displayRegionData("US", newCaseUS, newDeathUS);
				regions.sort();
				$.each(regions, function(i, region){
					$("select#regionSelect").append('<option value="' + region + '">' + region + '</option>');
				});
			}
		});
	}
	
	function main(){
		getCDCData(d);
		
		$("#test").text(d.toJSON());
		
		$("#regionSelect").change(function(e){
			if(e.target.value == "all"){
				displayRegionData("US", newCaseUS, newDeathUS);
			}
			else{
				$.each(covidData, function(i,stateData){
					if(stateData.state == e.target.value){
						//console.log(stateData.state + ": \n - New Cases: " + stateData.new_case + ": \n - New Deaths: " + stateData.new_death);
						displayRegionData(stateData.state, parseInt(stateData.new_case), parseInt(stateData.new_death));
					}
				})
			}
			
		});
	}
	
	main();
	
	
</script>
</html>